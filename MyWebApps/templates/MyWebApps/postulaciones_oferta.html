{% extends 'MyWebApps/base.html' %}

{% block title %}Postulaciones - {{ oferta.titulo }} - EMPLEOYA{% endblock %}

{% block content %}
<div class="container">
    <a href="{% url 'mis_ofertas' %}" class="btn btn-outline mb-2">‚Üê Volver a mis ofertas</a>

    <div class="card mb-3">
        <h1 style="margin-bottom: 1rem; color: var(--primary);">{{ oferta.titulo }}</h1>
        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text);">
            <span>üë• {{ postulaciones.count }} postulaciones</span>
            <span>üëÅÔ∏è {{ oferta.vistas }} vistas</span>
            <span>üìÖ Publicado: {{ oferta.fecha_publicacion|date:"d/m/Y" }}</span>
        </div>
    </div>

    {% if postulaciones %}
        <p class="text-muted mb-2">{{ postulaciones.count }} postulaciones recibidas</p>

        <!-- Filtros por estado -->
        <div class="card mb-3">
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="?estado=all" class="badge badge-primary" style="padding: 0.5rem 1rem; cursor: pointer;">
                    Todas ({{ postulaciones.count }})
                </a>
                <a href="?estado=pendiente" class="badge badge-warning" style="padding: 0.5rem 1rem; cursor: pointer;">
                    Pendientes ({{ postulaciones.filter.pendiente.count }})
                </a>
                <a href="?estado=en_revision" class="badge badge-primary" style="padding: 0.5rem 1rem; cursor: pointer;">
                    En Revisi√≥n ({{ postulaciones.filter.en_revision.count }})
                </a>
                <a href="?estado=preseleccionado" class="badge badge-success" style="padding: 0.5rem 1rem; cursor: pointer;">
                    Preseleccionados ({{ postulaciones.filter.preseleccionado.count }})
                </a>
            </div>
        </div>

        <div class="grid grid-2">
            {% for postulacion in postulaciones %}
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <h2 style="margin-bottom: 0.5rem; font-size: 1.25rem;">
                            {{ postulacion.postulante.usuario.nombre_completo }}
                        </h2>
                        {% if postulacion.postulante.titulo_profesional %}
                        <p class="text-muted" style="margin: 0; font-size: 0.875rem;">
                            {{ postulacion.postulante.titulo_profesional }}
                        </p>
                        {% endif %}
                    </div>
                    <span class="badge
                        {% if postulacion.estado == 'pendiente' %}badge-warning
                        {% elif postulacion.estado == 'en_revision' or postulacion.estado == 'preseleccionado' %}badge-primary
                        {% elif postulacion.estado == 'entrevista' %}badge-primary
                        {% elif postulacion.estado == 'aceptado' %}badge-success
                        {% elif postulacion.estado == 'rechazado' %}badge-danger
                        {% else %}badge-primary{% endif %}">
                        {{ postulacion.get_estado_display }}
                    </span>
                </div>

                <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 1rem;">
                    <p style="margin: 0.25rem 0;">üìß {{ postulacion.postulante.usuario.email }}</p>
                    {% if postulacion.postulante.usuario.telefono %}
                    <p style="margin: 0.25rem 0;">üì± {{ postulacion.postulante.usuario.telefono }}</p>
                    {% endif %}
                    {% if postulacion.postulante.ubicacion %}
                    <p style="margin: 0.25rem 0;">üìç {{ postulacion.postulante.ubicacion }}</p>
                    {% endif %}
                    {% if postulacion.postulante.a√±os_experiencia %}
                    <p style="margin: 0.25rem 0;">üíº {{ postulacion.postulante.a√±os_experiencia }} a√±os de experiencia</p>
                    {% endif %}
                    <p style="margin: 0.25rem 0;">üìÖ Postulado el {{ postulacion.fecha_postulacion|date:"d/m/Y H:i" }}</p>
                    {% if postulacion.puntuacion_match %}
                    <p style="margin: 0.25rem 0;">‚≠ê Match: {{ postulacion.puntuacion_match }}%</p>
                    {% endif %}
                </div>

                {% if postulacion.postulante.habilidades %}
                <div style="margin-bottom: 1rem;">
                    <p class="fw-bold" style="font-size: 0.875rem; margin-bottom: 0.5rem;">Habilidades:</p>
                    <p style="font-size: 0.875rem; color: var(--text);">{{ postulacion.postulante.habilidades|truncatewords:15 }}</p>
                </div>
                {% endif %}

                {% if postulacion.carta_presentacion %}
                <div style="background: var(--light); padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                    <p class="fw-bold" style="font-size: 0.875rem; margin-bottom: 0.5rem;">Carta de presentaci√≥n:</p>
                    <p style="font-size: 0.875rem; margin: 0; white-space: pre-line;">{{ postulacion.carta_presentacion|truncatewords:30 }}</p>
                </div>
                {% endif %}

                {% if postulacion.cv_url_postulacion %}
                <a href="{{ postulacion.cv_url_postulacion }}" target="_blank" class="btn btn-outline" style="width: 100%; margin-bottom: 0.5rem;">
                    üìÑ Ver CV
                </a>
                {% endif %}

                <!-- Acciones seg√∫n estado -->
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    {% if postulacion.estado == 'pendiente' %}
                        <form method="POST" action="{% url 'postulaciones_oferta' oferta.id %}" style="flex: 1;">
                            {% csrf_token %}
                            <input type="hidden" name="postulacion_id" value="{{ postulacion.id }}">
                            <input type="hidden" name="nuevo_estado" value="en_revision">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                Revisar
                            </button>
                        </form>
                    {% elif postulacion.estado == 'en_revision' %}
                        <form method="POST" action="{% url 'postulaciones_oferta' oferta.id %}" style="flex: 1;">
                            {% csrf_token %}
                            <input type="hidden" name="postulacion_id" value="{{ postulacion.id }}">
                            <input type="hidden" name="nuevo_estado" value="preseleccionado">
                            <button type="submit" class="btn btn-success" style="width: 100%;">
                                Preseleccionar
                            </button>
                        </form>
                    {% elif postulacion.estado == 'preseleccionado' %}
                        <form method="POST" action="{% url 'postulaciones_oferta' oferta.id %}" style="flex: 1;">
                            {% csrf_token %}
                            <input type="hidden" name="postulacion_id" value="{{ postulacion.id }}">
                            <input type="hidden" name="nuevo_estado" value="entrevista">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                Entrevista
                            </button>
                        </form>
                    {% elif postulacion.estado == 'entrevista' %}
                        <form method="POST" action="{% url 'postulaciones_oferta' oferta.id %}" style="flex: 1;">
                            {% csrf_token %}
                            <input type="hidden" name="postulacion_id" value="{{ postulacion.id }}">
                            <input type="hidden" name="nuevo_estado" value="aceptado">
                            <button type="submit" class="btn btn-success" style="width: 100%;">
                                Aceptar
                            </button>
                        </form>
                    {% endif %}

                    {% if postulacion.estado not in 'aceptado,rechazado' %}
                        <form method="POST" action="{% url 'postulaciones_oferta' oferta.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="postulacion_id" value="{{ postulacion.id }}">
                            <input type="hidden" name="nuevo_estado" value="rechazado">
                            <button type="submit" class="btn btn-danger">
                                Rechazar
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

    {% else %}
        <div class="card text-center" style="padding: 4rem 2rem;">
            <h2 style="color: var(--text); margin-bottom: 1rem;">No hay postulaciones a√∫n</h2>
            <p class="text-muted" style="margin-bottom: 2rem;">
                Cuando los postulantes se interesen en tu oferta, aparecer√°n aqu√≠
            </p>
            <a href="{% url 'oferta_detalle' oferta.id %}" class="btn btn-outline">
                Ver Mi Oferta
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}
